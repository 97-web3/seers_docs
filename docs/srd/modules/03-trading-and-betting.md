---
标题：模块规范 — 交易与投注
版本：0.1
最后更新：2025-12-14
所有者：产品与工程
状态：草稿
---

# 1. 模块概述

## 模块名称和标识符
- 名称：交易与投注
- ID：MOD-TRADING-BETTING

## 目的
使用户能够对市场期权下注，并清晰地展示报价明细（赌注/本金、费用、潜在回报），执行交易限制，并提供可靠的成功/失败反馈。

## 范围
- 范围内：期权选择（从详情页或卡片）、本金输入、报价计算显示、提交投注、加载状态、错误处理以及投注后的用户界面刷新触发。
- 范围外：除导向入口点外的钱包充值UI实现。

## 模块边界
从用户打算下注开始，到投注被确认、拒绝或取消结束。

## 依赖项
- 市场状态和期权可用性（[市场状态与结算](06-market-states-and-settlement.md)）
- 钱包余额和扣款（[钱包与支付](../integrations/wallet-and-payments.md)）
- 交易端点（[交易API](../api-specifications/trading.md)）
- 投资组合刷新（[投资组合与持仓](04-portfolio-and-positions.md)）

## 利益相关者
- 最终用户、风险/合规、产品、工程

# 2. 功能需求

## 需求列表
- FR-TB-001：系统应允许用户选择投注选项并输入本金金额。
- FR-TB-002：系统应提供快速金额操作：2、5、10、100，以及“全部”（指可用余额或其他定义的上限）。
- FR-TB-003：系统应显示报价摘要，包括：本金金额、潜在回报、费用金额和当前可用余额。
- FR-TB-004：潜在回报的计算方式为：`本金 * 十进制赔率(oddsDecimal)`；其中 `oddsDecimal` 为大于 1 的十进制赔率。
- FR-TB-005：费用的计算方式为：`本金 * 费率`，费率默认为 0.2%，除非另有配置。
- FR-TB-006：净利润的显示方式为：`潜在回报 - 本金 - 费用`。
- FR-TB-007：当满足以下任一条件时，确认按钮应禁用：（a）未选择任何选项，（b）本金为 0，或（c）可用余额不足。
- FR-TB-008：系统应强制执行投注限制：
  - 最低本金：1
  - 最高本金：不得超过可用余额
  - 附加上限：单笔投注不得超过市场流动性的 10%
- FR-TB-009：如果市场已过截止时间或未处于活跃可交易状态，投注将被拒绝。
- FR-TB-010：提交时，确认操作应显示加载状态并防止重复提交。
- FR-TB-011：投注成功后，系统应显示成功消息并触发刷新：市场流动性、赔率/份额展示、持仓和趋势数据。
- FR-TB-012：投注失败时，系统应显示有理由的错误消息并保留用户输入的本金。
- FR-TB-013：如果用户余额不足，系统应显示一个余额不足的对话框，并提供充值导航入口。
- FR-TB-014：投注扣款必须包含费用；实际扣款金额为：`本金 + 费用`，并且该值必须与报价展示一致。

## 用户故事
- 作为一个最终用户，我希望在确认前看到潜在回报和费用，以便我了解我的财务风险。
- 作为一个最终用户，我希望系统能防止重复提交，以免我不小心下注两次。
- 作为一个最终用户，我希望错误提示清晰且能保留我的输入，以便我能快速修复问题。

## 用例
### UC-TB-001：从市场详情页下注
- 参与者：最终用户
- 前置条件：市场处于活动状态；期权可用；用户有钱包余额
- 主流程：
  1. 用户选择一个期权。
  2. 用户输入本金（或选择快速金额）。
  3. 系统显示报价明细（潜在回报、费用、净利润）。
  4. 用户确认。
  5. 系统提交投注，扣除钱包余额，记录持仓，并返回确认信息。
  6. 系统刷新市场和投资组合部分。
- 替代流程：
  - A1：本金超过 10% 的流动性 → 系统以验证消息阻止。
  - A2：市场截止时间已过 → 系统阻止并告知用户。
  - A3：网络失败 → 系统显示重试选项并保留输入。

## 业务规则
- BR-TB-001：费率默认为 0.2%；任何更改必须由配置驱动且版本化。
- BR-TB-002：单笔投注的流动性上限为提交时市场流动性的 10%。
- BR-TB-003：市场截止时间以服务器端时间为准；客户端时间检查仅供参考。

## 验证规则
- VR-TB-001：本金必须是具有定义精度（待定；建议显示时保留 2 位小数）的正十进制数。
- VR-TB-002：“全部”快速金额解析为在应用所有限制后的最大允许投注额。

# 3. API 规范（技术无关）
完整的合约请参见 [交易API](../api-specifications/trading.md)。

## 端点定义（摘要）
- `POST /api/trading/quote`
- `POST /api/trading/bets`
- `GET /api/wallet/balance`
- `GET /api/trading/bets/{betId}`

## 身份验证/授权
- 所有交易端点都需要经过身份验证的用户。
- 授权必须确保用户只能对其自己的账户下注，并且只能查看自己的投注记录。

## 错误处理
- 错误信息采用 [通用错误](../api-specifications/common-errors.md) 中的标准错误信封。
- 错误必须足够具体，以支持用户界面消息（例如：`INSUFFICIENT_BALANCE`（余额不足）、`MARKET_CLOSED`（市场关闭）、`LIMIT_EXCEEDED`（超出限制））。

# 4. 数据模型和架构
请参见 [实体](../data-models/entities.md) 和 [JSON 架构](../data-models/json-schemas.md)。

## 使用的关键实体
- WalletBalance（钱包余额）、TradeQuote（交易报价）、BetOrder（投注订单）、Position（持仓）

# 5. 业务逻辑需求

## 报价计算
- BL-TB-001：UI中显示的报价值（潜在回报、费用、净利润、适用的 `oddsDecimal`）必须与服务器对相同输入的返回报价一致。
- BL-TB-002：如果服务器报价与客户端预览的差异超出容差（待定），UI必须在确认前或确认时更新为服务器值。

## 幂等性
- BL-TB-003：投注提交必须支持幂等性密钥，以防止重复扣款和重复订单。

# 6. 集成点
- 钱包/支付系统（用于余额检索和扣款）。
- 市场服务（用于检索当前流动性和隐含概率）。

# 7. 非功能性需求
- NFR-TB-001：投注提交必须可靠且可审计；每笔投注必须可通过请求标识符进行追溯。
- NFR-TB-002：错误消息必须对用户友好，且不泄露敏感的内部细节。
- NFR-TB-003：系统必须通过 UI 和 API 幂等性防止重复提交。

# 8. 验收标准
- AC-TB-001：当未选择期权、本金为 0 或余额不足时，确认按钮被禁用。
- AC-TB-002：超过流动性 10% 的投注将以清晰的消息被拒绝。
- AC-TB-003：成功投注后，持仓和市场指标在无需手动刷新页面的情况下得到更新。
- AC-TB-004：失败时，本金输入内容保留，用户可以重试。
